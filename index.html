<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPod Classic Pro</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root { --ipod-bg: #d4d4d4; --wheel-bg: #fff; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: #1a1a1a; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: sans-serif; overflow: hidden; }
        .ipod { width: 330px; height: 530px; background: var(--ipod-bg); border-radius: 35px; padding: 20px; display: flex; flex-direction: column; align-items: center; box-shadow: inset 0 0 15px #fff, 10px 10px 30px #000; position: relative; }
        .screen { width: 280px; height: 210px; background: #fff; border: 3px solid #333; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .status-bar { height: 22px; background: linear-gradient(#eee, #bbb); display: flex; justify-content: space-between; align-items: center; padding: 0 8px; font-size: 11px; font-weight: bold; border-bottom: 1px solid #999; }
        .view { display: none; width: 100%; height: calc(100% - 22px); flex-direction: column; overflow: hidden; }
        .view.active { display: flex; }
        .menu-header { background: linear-gradient(#eee, #ccc); padding: 5px; font-size: 13px; font-weight: bold; border-bottom: 1px solid #999; text-align: center; }
        .menu-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .menu-item { padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 14px; color: #333; display: flex; justify-content: space-between; }
        .menu-item.selected { background: linear-gradient(#5eaef5, #1d73c9); color: #fff; }
        .player-layout { display: flex; padding: 15px; gap: 15px; height: 135px; }
        .art { width: 105px; height: 105px; background: #ddd; border: 1px solid #999; background-size: cover; background-position: center; flex-shrink: 0; }
        .info { flex: 1; overflow: hidden; }
        .info h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info p { margin: 2px 0; font-size: 11px; color: #666; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .progress-cont { width: 90%; height: 12px; background: #fff; border: 1px solid #bbb; margin: 5px auto; position: relative; }
        .bar { height: 100%; background: linear-gradient(#8ec1f5, #3672b5); width: 0%; }
        .times { display: flex; justify-content: space-between; width: 90%; margin: 0 auto; font-size: 10px; font-family: monospace; }
        #context-menu { position: absolute; top: 22px; left: 0; width: 100%; height: calc(100% - 22px); background: rgba(255,255,255,0.95); display: none; flex-direction: column; z-index: 100; }
        .context-btn { padding: 15px; text-align: center; border-bottom: 1px solid #ddd; font-size: 14px; color: #333; font-weight: bold; }
        .wheel-cont { width: 240px; height: 240px; background: var(--wheel-bg); border-radius: 50%; margin-top: 30px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); touch-action: none; }
        .center-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85px; height: 85px; background: #e0e0e0; border-radius: 50%; border: 1px solid #ccc; z-index: 10; cursor: pointer; }
        .btn { position: absolute; font-weight: bold; color: #bbb; font-size: 14px; padding: 20px; z-index: 5; cursor: pointer; }
        .top { top: 0; left: 50%; transform: translateX(-50%); }
        .right { right: 0; top: 50%; transform: translateY(-50%); }
        .left { left: 0; top: 50%; transform: translateY(-50%); }
        .bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        #folderInput { display: none; }
    </style>
</head>
<body>

<div class="ipod">
    <div class="screen">
        <div class="status-bar"><span id="p-status">‚è∏</span><span id="time">12:00</span><span>üîã</span></div>
        <div id="context-menu">
            <div class="menu-header">Opciones</div>
            <div class="context-btn" onclick="addToQueue('next')">Reproducir siguiente</div>
            <div class="context-btn" onclick="addToQueue('last')">A√±adir al final</div>
            <div class="context-btn" style="color:red" onclick="closeContext()">Cancelar</div>
        </div>
        <div id="view-main" class="view active">
            <div class="menu-header">iPod</div>
            <ul class="menu-list">
                <li class="menu-item selected" data-view="view-music-nav">M√∫sica ></li>
                <li class="menu-item" data-view="view-player">Ahora suena ></li>
                <li class="menu-item" data-view="view-queue">Ver cola ></li>
                <li class="menu-item" id="btn-sync" onclick="document.getElementById('folderInput').click()">Sincronizar m√∫sica...</li>
            </ul>
        </div>
        <div id="view-music-nav" class="view">
            <div class="menu-header">M√∫sica</div>
            <ul class="menu-list">
                <li class="menu-item selected" data-view="view-albums">√Ålbumes ></li>
                <li class="menu-item" data-view="view-songs-all">Todas las canciones ></li>
            </ul>
        </div>
        <div id="view-albums" class="view">
            <div class="menu-header">√Ålbumes</div>
            <ul class="menu-list" id="list-albums"></ul>
        </div>
        <div id="view-songs" class="view">
            <div class="menu-header" id="songs-title">Canciones</div>
            <ul class="menu-list" id="list-songs"></ul>
        </div>
        <div id="view-queue" class="view">
            <div class="menu-header">Cola</div>
            <ul class="menu-list" id="list-queue"></ul>
        </div>
        <div id="view-player" class="view">
            <div class="player-layout">
                <div id="p-art" class="art"></div>
                <div class="info"><h4 id="p-title">Nada sonando</h4><p id="p-artist">---</p><p id="p-album" style="color: #999; font-size: 10px;"></p></div>
            </div>
            <div class="progress-cont"><div id="p-bar" class="bar"></div></div>
            <div class="times"><span id="p-curr">0:00</span><span id="p-rem">-0:00</span></div>
        </div>
    </div>
    
    <input type="file" id="folderInput" multiple accept="audio/*">
    <audio id="audio"></audio>
    
    <audio id="snd-scroll" src="scroll.mp3" preload="auto"></audio>
    <audio id="snd-select" src="select.mp3" preload="auto"></audio>

    <div class="wheel-cont" id="wheel">
        <div class="btn top" onclick="goBack()">MENU</div>
        <div class="btn right" onclick="nextTrack()">‚è≠</div>
        <div class="btn left" onclick="prevTrack()">‚èÆ</div>
        <div class="btn bottom" onclick="togglePlay()">‚ñ∂||</div>
        <div class="center-btn" id="center-button"></div>
    </div>
</div>

<script>
    const audio = document.getElementById('audio');
    const sndScroll = document.getElementById('snd-scroll');
    const sndSelect = document.getElementById('snd-select');
    
    let masterList = [], albums = {}, queue = [], currentList = [], playedSongs = [];
    let selectedIdx = 0, currentView = 'view-main', pendingActionFile = null, currentSongFile = null;
    let db;

    // --- FUNCIONES DE SONIDO ---
    function playScrollSnd() {
        sndScroll.currentTime = 0;
        sndScroll.play().catch(() => {});
    }
    function playSelectSnd() {
        sndSelect.currentTime = 0;
        sndSelect.play().catch(() => {});
    }

    // --- BASE DE DATOS ---
    const request = indexedDB.open("iPodLibrary", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("songs", { keyPath: "name" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadLibrary();
    };

    document.getElementById('folderInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        const tx = db.transaction("songs", "readwrite");
        const store = tx.objectStore("songs");
        document.getElementById('btn-sync').innerText = "Guardando...";
        for (const file of files) { store.put(file); }
        tx.oncomplete = () => {
            document.getElementById('btn-sync').innerText = "Sincronizar m√∫sica...";
            loadLibrary();
            playSelectSnd();
        };
    });

    function loadLibrary() {
        const tx = db.transaction("songs", "readonly");
        const store = tx.objectStore("songs");
        const requestAll = store.getAll();
        requestAll.onsuccess = () => {
            masterList = requestAll.result;
            if (masterList.length > 0) processAlbums(masterList);
        };
    }

    function processAlbums(files) {
        albums = {"Todas": files};
        files.forEach(file => {
            jsmediatags.read(file, {
                onSuccess: (t) => {
                    const alb = t.tags.album || "Desconocido";
                    if (!albums[alb]) albums[alb] = [];
                    albums[alb].push(file);
                }
            });
        });
    }

    // --- NAVEGACI√ìN ---
    function goBack() {
        if (document.getElementById('context-menu').style.display === 'flex') { closeContext(); return; }
        const tree = { 'view-player': 'view-main', 'view-queue': 'view-main', 'view-songs': 'view-music-nav', 'view-albums': 'view-music-nav', 'view-music-nav': 'view-main' };
        if (tree[currentView]) {
            switchView(tree[currentView]);
            playSelectSnd();
        }
    }

    function handleSelect() {
        const sel = document.querySelector(`#${currentView} .selected`);
        if (!sel) return;
        
        playSelectSnd();

        if (currentView === 'view-main' || currentView === 'view-music-nav') {
            const nextV = sel.dataset.view;
            if (nextV === 'view-albums') renderAlbums();
            if (nextV === 'view-songs-all') { renderSongs(masterList, "Todas las canciones"); switchView('view-songs'); return; }
            if (nextV === 'view-queue') renderQueue();
            if (nextV) switchView(nextV);
        } else if (currentView === 'view-albums') {
            renderSongs(albums[sel.dataset.album], sel.dataset.album);
            switchView('view-songs');
        } else if (currentView === 'view-songs') {
            const idx = Array.from(sel.parentNode.children).indexOf(sel);
            queue = currentList.slice(idx + 1);
            playSong(currentList[idx]);
            switchView('view-player');
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        currentView = id;
        selectedIdx = 0;
    }

    function renderAlbums() {
        const list = document.getElementById('list-albums');
        list.innerHTML = Object.keys(albums).map((a, i) => `<li class="menu-item ${i===0?'selected':''}" data-album="${a}">${a}</li>`).join('');
    }

    function renderSongs(songArray, title) {
        currentList = songArray;
        document.getElementById('songs-title').innerText = title;
        document.getElementById('list-songs').innerHTML = songArray.map((s, i) => `<li class="menu-item ${i===0?'selected':''}" data-index="${i}">${s.name.replace('.mp3','').slice(0,25)}</li>`).join('');
    }

    function renderQueue() {
        document.getElementById('list-queue').innerHTML = queue.length ? queue.map(s => `<li class="menu-item">${s.name.slice(0,25)}</li>`).join('') : `<li class="menu-item">Cola vac√≠a</li>`;
    }

    // --- REPRODUCCI√ìN Y MEDIA SESSION ---
    function updateMediaSession(title, artist, album, artBlob) {
        if ('mediaSession' in navigator) {
            const artUrl = artBlob ? URL.createObjectURL(artBlob) : '';
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title, artist: artist, album: album,
                artwork: [{ src: artUrl, sizes: '512x512', type: 'image/png' }]
            });
            navigator.mediaSession.setActionHandler('play', () => togglePlay());
            navigator.mediaSession.setActionHandler('pause', () => togglePlay());
            navigator.mediaSession.setActionHandler('previoustrack', () => prevTrack());
            navigator.mediaSession.setActionHandler('nexttrack', () => nextTrack());
        }
    }

    function playSong(file) {
        if (currentSongFile) playedSongs.push(currentSongFile);
        currentSongFile = file;
        audio.src = URL.createObjectURL(file);
        audio.play();
        updateMetadata(file);
    }

    function togglePlay() { 
        if (audio.paused) audio.play(); else audio.pause(); 
        playSelectSnd();
    }

    function nextTrack() { 
        if (queue.length > 0) {
            playSong(queue.shift());
            playSelectSnd();
        }
    }

    function prevTrack() { 
        playSelectSnd();
        if (audio.currentTime > 3) {
            audio.currentTime = 0;
        } else if (playedSongs.length > 0) {
            const last = playedSongs.pop();
            queue.unshift(currentSongFile);
            playSong(last);
        }
    }
    
    audio.onplay = () => {
        document.getElementById('p-status').innerText = "‚ñ∂";
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
    };
    audio.onpause = () => {
        document.getElementById('p-status').innerText = "‚è∏";
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
    };
    audio.onended = () => nextTrack();

    function updateMetadata(file) {
        jsmediatags.read(file, {
            onSuccess: (t) => {
                const tags = t.tags;
                const title = tags.title || file.name;
                const artist = tags.artist || "Desconocido";
                const album = tags.album || "";
                document.getElementById('p-title').innerText = title;
                document.getElementById('p-artist').innerText = artist;
                document.getElementById('p-album').innerText = album;
                let artBlob = null;
                if (tags.picture) {
                    const { data, format } = tags.picture;
                    artBlob = new Blob([new Uint8Array(data)], { type: format });
                    const reader = new FileReader();
                    reader.onload = (e) => { document.getElementById('p-art').style.backgroundImage = `url(${e.target.result})`; };
                    reader.readAsDataURL(artBlob);
                } else { document.getElementById('p-art').style.backgroundImage = 'none'; }
                updateMediaSession(title, artist, album, artBlob);
            }
        });
    }

    // --- RUEDA (SCROLL CON SONIDO) ---
    let lastAngle = null;
    document.getElementById('wheel').addEventListener('touchmove', (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const centerX = rect.left + rect.width/2; const centerY = rect.top + rect.height/2;
        const angle = Math.atan2(e.touches[0].clientY - centerY, e.touches[0].clientX - centerX) * 180 / Math.PI;
        if (lastAngle !== null) {
            let d = angle - lastAngle;
            if (d > 180) d -= 360; if (d < -180) d += 360;
            if (Math.abs(d) > 15) {
                const items = document.querySelectorAll(`#${currentView} .menu-list .menu-item`);
                if (items.length > 1) {
                    items[selectedIdx].classList.remove('selected');
                    selectedIdx = (selectedIdx + (d > 0 ? 1 : -1) + items.length) % items.length;
                    items[selectedIdx].classList.add('selected');
                    items[selectedIdx].scrollIntoView({block:'nearest'});
                    playScrollSnd(); // <--- Sonido de click en cada salto
                }
                lastAngle = angle;
            }
        } else lastAngle = angle;
    });

    let holdTimer;
    const centerBtn = document.getElementById('center-button');
    centerBtn.addEventListener('touchstart', () => {
        holdTimer = setTimeout(() => {
            if (currentView === 'view-songs') {
                const sel = document.querySelector(`#${currentView} .selected`);
                if(sel) {
                    pendingActionFile = currentList[Array.from(sel.parentNode.children).indexOf(sel)];
                    document.getElementById('context-menu').style.display = 'flex';
                    playSelectSnd();
                }
            }
        }, 800);
    });
    centerBtn.addEventListener('touchend', () => clearTimeout(holdTimer));
    centerBtn.addEventListener('click', () => {
        if (document.getElementById('context-menu').style.display === 'flex') return;
        handleSelect();
    });

    function closeContext() { document.getElementById('context-menu').style.display = 'none'; playSelectSnd(); }
    function addToQueue(mode) { 
        if (mode === 'next') queue.unshift(pendingActionFile); else queue.push(pendingActionFile); 
        closeContext(); 
    }

    audio.ontimeupdate = () => {
        const pct = (audio.currentTime / audio.duration) * 100 || 0;
        document.getElementById('p-bar').style.width = pct + "%";
        document.getElementById('p-curr').innerText = Math.floor(audio.currentTime/60) + ":" + Math.floor(audio.currentTime%60).toString().padStart(2,'0');
        const rem = Math.max(0, audio.duration - audio.currentTime);
        document.getElementById('p-rem').innerText = "-" + Math.floor(rem/60) + ":" + Math.floor(rem%60).toString().padStart(2,'0');
    };

    setInterval(() => {
        document.getElementById('time').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
    }
</script>
</body>
</html>
